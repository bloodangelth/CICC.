<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CICC Admin Panel</title>
    <link rel="stylesheet" href="style1.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h3><i class="fas fa-lock"></i> Admin Login</h3>
        <input type="password" id="adminPassword" placeholder="‡∏£‡∏´‡∏±‡∏™: 1234" onkeydown="if(event.key==='Enter') window.checkPassword()">
        <button class="btn-save" onclick="window.checkPassword()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
</div>

<div class="container" id="mainContainer">
    <h2>
        <span><i class="fas fa-chart-line"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span>
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö</a>
    </h2>

    <div class="stats-grid">
        <div class="stat-card"><h4>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h4><div class="number" id="statToday">...</div></div>
        <div class="stat-card"><h4>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h4><div class="number" id="statMonth">...</div></div>
        <div class="stat-card"><h4>‡∏£‡∏ß‡∏°</h4><div class="number" id="statTotal">...</div></div>
    </div>

    <h3 style="color:var(--primary-color); border-bottom:1px solid #eee; padding-bottom:10px; margin-top:30px;">
        <i class="fas fa-robot"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö & ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π
    </h3>
    
    <div class="form-group">
        <label>‡∏Ñ‡∏≥‡∏´‡∏•‡∏±‡∏Å (Keywords):</label>
        <input type="text" id="keywordsInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏¢‡∏®.‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏´‡∏ô, ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥)">
        <small style="color:#888; display:block; margin-top:-10px; margin-bottom:10px;">* ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏Å‡πá‡∏û‡∏≠ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</small>
    </div>
    
    <div class="form-group">
        <label>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û):</label>
        
        <div class="editor-container">
            <div class="editor-toolbar">
                <input type="file" id="imgUpload" hidden accept="image/*" onchange="window.handleImageUpload(this)">
                
                <button class="tool-btn" onclick="document.getElementById('imgUpload').click()">
                    <i class="fas fa-image"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                </button>
                <button class="tool-btn" onclick="document.execCommand('bold')">
                    <i class="fas fa-bold"></i> ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤
                </button>
                <button class="tool-btn" onclick="document.execCommand('createLink', false, prompt('‡πÉ‡∏™‡πà‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå:', 'http://'))">
                    <i class="fas fa-link"></i> ‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå
                </button>
            </div>
            <div id="richEditor" contenteditable="true" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û..."></div>
        </div>
    </div>

    <label class="checkbox-wrapper" style="display:flex; align-items:center; gap:10px; margin:15px 0; cursor:pointer;">
        <input type="checkbox" id="addToQuickCheck" onchange="window.toggleQuickOption()" style="width:auto; margin:0;"> 
        <span><i class="fas fa-plus-square"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏¢ (Quick Menu)</span>
    </label>

    <div id="quickOptionBox" class="quick-option-box" style="display:none;">
        <div class="form-group">
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°:</label>
            <input type="text" id="quickLabelInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£">
        </div>
        <div class="form-group">
            <label>‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô:</label>
            <input type="text" id="quickIconInput" placeholder="fas fa-star" value="fas fa-star" oninput="window.updateIconPreview()">
            <div id="iconPreview" class="icon-preview" style="margin-top:5px; font-size:1.5rem; color:var(--primary-color);"><i class="fas fa-star"></i></div>
        </div>
    </div>

    <button class="btn-save" id="saveBtn" style="margin-top:15px;" onclick="window.saveResponse()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button class="btn-cancel" id="cancelBtn" onclick="window.cancelEdit()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>

    <h4 style="margin-top:30px; color:#666;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
    <div class="table-wrapper">
        <table>
            <thead><tr><th width="30%">‡∏Ñ‡∏≥‡∏´‡∏•‡∏±‡∏Å</th><th width="50%">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</th><th width="20%">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody id="responseTable"></tbody>
        </table>
    </div>
    
    <div style="height:50px;"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- ‡∏£‡∏´‡∏±‡∏™ Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
    const firebaseConfig = {
      apiKey: "AIzaSyBs-1OF_k_iUsydZF5DjLFRnv0fcTAJxiE",
      authDomain: "cicc-91f0b.firebaseapp.com",
      databaseURL: "https://cicc-91f0b-default-rtdb.firebaseio.com",
      projectId: "cicc-91f0b",
      storageBucket: "cicc-91f0b.firebasestorage.app",
      messagingSenderId: "596317132498",
      appId: "1:596317132498:web:e5c4bc56a55d26940e7f0b",
      measurementId: "G-GK5FB9CCRF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let botData = [];
    let quickData = [];
    let visitLogs = [];
    let editIndex = -1;
    const ADMIN_PASS = "1234";

    // --- Login ---
    window.checkPassword = function() {
        if(document.getElementById('adminPassword').value === ADMIN_PASS) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            startListening();
        } else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î!");
    }

    function startListening() {
        onValue(ref(db, 'cicc_bot_data'), (snap) => {
            botData = snap.val() || [];
            renderTable();
        });
        onValue(ref(db, 'cicc_quick_btns'), (snap) => {
            quickData = snap.val() || [];
        });
        onValue(ref(db, 'cicc_visit_logs'), (snap) => {
            const data = snap.val();
            visitLogs = data ? Object.values(data) : [];
            loadStats();
        });
    }

    // --- Image Upload Logic (‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á ‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå‡πÇ‡∏Ñ‡πâ‡∏î) ---
    window.handleImageUpload = function(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const imgTag = `<br><img src="${e.target.result}"><br>`;
                document.getElementById('richEditor').focus();
                // ‡πÅ‡∏ó‡∏£‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏≠‡∏¢‡∏π‡πà
                document.execCommand('insertHTML', false, imgTag);
            };
            reader.readAsDataURL(file);
            input.value = ''; // Reset
        }
    }

    // --- Save Logic ---
    window.saveResponse = function() {
        const k = document.getElementById('keywordsInput').value;
        // ‡∏î‡∏∂‡∏á HTML ‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á Rich Editor (‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢)
        const r = document.getElementById('richEditor').innerHTML;
        
        if(!k || !r || r === '<br>') return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        
        const obj = { keywords: k.split(',').map(s=>s.trim()).filter(x=>x), response: r };
        let newData = [...botData];

        if(editIndex === -1) newData.push(obj);
        else { newData[editIndex] = obj; window.cancelEdit(); }
        
        set(ref(db, 'cicc_bot_data'), newData);

        // Quick Menu Logic
        if (document.getElementById('addToQuickCheck').checked) {
            const qLabel = document.getElementById('quickLabelInput').value;
            const qIcon = document.getElementById('quickIconInput').value;
            if (qLabel) {
                let newQData = [...quickData];
                newQData.push({ label: qLabel, icon: qIcon, message: obj.keywords[0] });
                set(ref(db, 'cicc_quick_btns'), newQData);
            }
        }
        
        window.cancelEdit();
    }

    window.editItem = function(i) {
        document.getElementById('keywordsInput').value = botData[i].keywords.join(', ');
        document.getElementById('richEditor').innerHTML = botData[i].response; // ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏™‡πà‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
        
        editIndex = i;
        const btn = document.getElementById('saveBtn');
        btn.innerHTML = '<i class="fas fa-save"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï';
        btn.style.background = '#ff9800';
        document.getElementById('cancelBtn').style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    window.deleteItem = function(i) {
        if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) {
            let newData = [...botData];
            newData.splice(i, 1);
            set(ref(db, 'cicc_bot_data'), newData);
        }
    }

    window.cancelEdit = function() {
        editIndex = -1;
        document.getElementById('keywordsInput').value=''; 
        document.getElementById('richEditor').innerHTML='';
        document.getElementById('addToQuickCheck').checked = false;
        document.getElementById('quickOptionBox').style.display = 'none';

        const btn = document.getElementById('saveBtn');
        btn.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        btn.style.background = 'var(--primary-color)';
        document.getElementById('cancelBtn').style.display='none';
    }

    // --- Table Render ---
    function renderTable() {
        const tbody = document.getElementById('responseTable');
        tbody.innerHTML = '';
        botData.forEach((item, i) => {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ)
            let tempDiv = document.createElement("div");
            tempDiv.innerHTML = item.response;
            let previewText = tempDiv.textContent || tempDiv.innerText || "";
            if(item.response.includes("<img")) previewText = "üì∑ [‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û] " + previewText;
            if(previewText.length > 40) previewText = previewText.substring(0,40) + "...";

            tbody.innerHTML += `<tr>
                <td>${item.keywords.map(k => `<span class="keyword-tag">${k}</span>`).join('')}</td>
                <td>${previewText}</td>
                <td class="actions">
                    <button class="btn-edit" onclick="window.editItem(${i})"><i class="fas fa-edit"></i></button> 
                    <button class="btn-delete" onclick="window.deleteItem(${i})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
    }

    function loadStats() {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        const month = now.toISOString().slice(0, 7);
        
        document.getElementById('statToday').innerText = visitLogs.filter(t => t.startsWith(today)).length;
        document.getElementById('statMonth').innerText = visitLogs.filter(t => t.startsWith(month)).length;
        document.getElementById('statTotal').innerText = visitLogs.length;
    }

    window.toggleQuickOption = function() {
        const box = document.getElementById('quickOptionBox');
        if (document.getElementById('addToQuickCheck').checked) {
            box.style.display = 'block';
            const kw = document.getElementById('keywordsInput').value.split(',')[0].trim();
            if(kw && !document.getElementById('quickLabelInput').value) 
                document.getElementById('quickLabelInput').value = kw;
            window.updateIconPreview();
        } else box.style.display = 'none';
    }

    window.updateIconPreview = function() {
        const val = document.getElementById('quickIconInput').value;
        document.getElementById('iconPreview').innerHTML = val ? `<i class="${val}"></i>` : '';
    }
</script>

</body>
</html>
