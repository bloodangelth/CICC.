<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CICC Chatbot</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <div class="chatbot-container">
        <div id="notificationBar" class="notification-bar">
            <div class="notif-content">
                <i class="fas fa-bullhorn"></i>
                <div class="marquee-wrapper">
                    <span class="marquee-text" id="notifText">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®: ...</span>
                </div>
            </div>
            <button class="notif-close" onclick="closeNotification()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <header class="chatbot-header">
            <div class="header-content">
                <img src="cicc.png" class="logo" alt="CICC Logo">
                <div class="title-group">
                    <h3>CICC Chatbot</h3>
                    <p>‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‚Ä¢ AI Model CICC</p>
                </div>
            </div>
            <a href="admin.html" class="admin-link" title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö">
                <i class="fas fa-cog"></i>
            </a>
        </header>

        <div class="chat-area" id="chatArea">
            <div class="message-group bot">
                <div class="avatar">
                    <img src="cicc.png" alt="Bot">
                </div>
                <div class="message bot-message">
                    <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ CICC Chatbot ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡∏ö</p>
                    <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üëá</p>
                    
                    <button class="tts-btn" onclick="playFinalVoice('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ CICC Chatbot ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö')">
                        <i class="fas fa-volume-up"></i> ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                    </button>
                </div>
            </div>
        </div>

        <div class="chat-input-area">
            <div class="quick-menu-bar" id="quickMenuBar"></div>
            <div class="chat-input-wrapper">
                <textarea id="userInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." rows="1"></textarea>
                <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
            <p class="disclaimer">‚ö† ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</p>
        </div>
    </div>

<script>
let appendMessage, getBotResponse, playFinalVoice;
let currentAudio = null;

function recordVisit() {
    const STORAGE_KEY = 'cicc_visit_logs';
    let logs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    logs.push(new Date().toISOString());
    localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
}

function loadNotification() {
    const NOTIF_KEY = 'cicc_notification';
    const notifData = JSON.parse(localStorage.getItem(NOTIF_KEY) || '{"active": false, "message": ""}');
    
    const bar = document.getElementById('notificationBar');
    const text = document.getElementById('notifText');

    if (notifData.active && notifData.message) {
        text.textContent = notifData.message;
        bar.style.display = 'flex';
    } else {
        bar.style.display = 'none';
    }
}

function closeNotification() {
    document.getElementById('notificationBar').style.display = 'none';
}

function renderQuickButtons() {
    const bar = document.getElementById('quickMenuBar');
    const defaultBtns = [
        { label: "‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£", icon: "far fa-clock", message: "‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£" },
        { label: "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠", icon: "fas fa-phone-alt", message: "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" },
        { label: "‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å", icon: "fas fa-book-open", message: "‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å" }
    ];
    const buttons = JSON.parse(localStorage.getItem('cicc_quick_btns') || JSON.stringify(defaultBtns));
    bar.innerHTML = '';
    buttons.forEach(btn => {
        const button = document.createElement('button');
        button.className = 'quick-btn';
        button.onclick = () => sendQuickMessage(btn.message);
        button.innerHTML = `<i class="${btn.icon}"></i> ${btn.label}`;
        bar.appendChild(button);
    });
}

document.addEventListener('DOMContentLoaded', () => {
    recordVisit();
    renderQuickButtons();
    loadNotification();

    const chatArea = document.getElementById('chatArea');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    const defaultBotData = [
        { keywords: ["‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ", "‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ"], response: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?" },
        { keywords: ["‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£"], response: "üïí <b>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£:</b><br>‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‚Äì ‡∏®‡∏∏‡∏Å‡∏£‡πå<br>08.30 ‚Äì 16.30 ‡∏ô." },
        { keywords: ["‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠"], response: "üìû <b>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</b><br>‡πÇ‡∏ó‡∏£: 064 565 3117" }
    ];

    function loadBotData() {
        const stored = localStorage.getItem('cicc_bot_data');
        return stored ? JSON.parse(stored) : defaultBotData;
    }

    playFinalVoice = function(text) {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
        }
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
        }
        let cleanText = text.replace(/<[^>]*>/g, ' ').replace(/&nbsp;/g, ' ').trim();
        if(!cleanText) return;
        playGoogleQueue(cleanText);
    }

    function playGoogleQueue(text) {
        const MAX_LEN = 100; 
        let sentences = [];
        while (text.length > 0) {
            let chunk = text.substring(0, MAX_LEN);
            let lastSpace = chunk.lastIndexOf(' ');
            if (lastSpace > 0 && text.length > MAX_LEN) chunk = chunk.substring(0, lastSpace);
            sentences.push(chunk);
            text = text.substring(chunk.length).trim();
        }
        let index = 0;
        function playNextChunk() {
            if (index >= sentences.length) return; 
            let chunk = sentences[index];
            let url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(chunk)}&tl=th&client=tw-ob`;
            let audio = new Audio(url);
            currentAudio = audio; 
            audio.onended = function() { index++; playNextChunk(); };
            audio.onerror = function() { playNativeFallback(sentences.slice(index).join(" ")); };
            let playPromise = audio.play();
            if (playPromise !== undefined) { playPromise.catch(error => { playNativeFallback(sentences.slice(index).join(" ")); }); }
        }
        playNextChunk();
    }

    function playNativeFallback(text) {
        if (!('speechSynthesis' in window)) return;
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'th-TH'; 
        utterance.rate = 1.0;
        let voices = window.speechSynthesis.getVoices();
        let thaiVoice = voices.find(v => v.lang.includes('th'));
        if (thaiVoice) utterance.voice = thaiVoice;
        window.speechSynthesis.speak(utterance);
    }

    appendMessage = function(sender, text) {
        const messageGroup = document.createElement('div');
        messageGroup.classList.add('message-group', sender);

        const avatarDiv = document.createElement('div');
        avatarDiv.classList.add('avatar');
        if (sender === 'user') {
            const iconSpan = document.createElement('span');
            iconSpan.classList.add('avatar-icon');
            iconSpan.textContent = 'üë§'; 
            avatarDiv.appendChild(iconSpan);
        } else {
            const img = document.createElement('img');
            img.src = 'cicc.png';
            img.alt = 'CICC Bot';
            avatarDiv.appendChild(img);
        }
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', `${sender}-message`);
        messageDiv.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`;
        if (sender === 'bot') {
            const ttsButton = document.createElement('button');
            ttsButton.className = 'tts-btn';
            ttsButton.innerHTML = '<i class="fas fa-volume-up"></i> ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
            ttsButton.onclick = function() { playFinalVoice(text); };
            messageDiv.appendChild(ttsButton);
        }
        messageGroup.appendChild(avatarDiv);
        messageGroup.appendChild(messageDiv);
        chatArea.appendChild(messageGroup);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    getBotResponse = function(text) {
        const msg = text.toLowerCase().trim();
        const botData = loadBotData();
        for (let item of botData) {
            for (let keyword of item.keywords) {
                if (msg.includes(keyword.toLowerCase())) return item.response;
            }
        }
        return "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ \n‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô '‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£' ‡∏´‡∏£‡∏∑‡∏≠ '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠' ‡∏î‡∏π‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö";
    }

    window.processUserMessage = function(text) {
        if (!text) return;
        appendMessage("user", text);
        setTimeout(() => { appendMessage("bot", getBotResponse(text)); }, 500);
    }

    function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;
        userInput.value = "";
        adjustTextareaHeight();
        processUserMessage(text);
    }

    sendBtn.addEventListener("click", sendMessage);

    userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    function adjustTextareaHeight() {
        userInput.style.height = "auto";
        userInput.style.height = userInput.scrollHeight + "px";
        if(userInput.value === '') userInput.style.height = 'auto';
    }

    userInput.addEventListener("input", adjustTextareaHeight);
});

function sendQuickMessage(text) {
    if (window.processUserMessage) window.processUserMessage(text);
}
</script>

</body>
</html>
