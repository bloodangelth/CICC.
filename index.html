<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CICC Chatbot</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div class="chatbot-container">
        <div id="notificationBar" class="notification-bar">
            <div class="notif-content">
                <i class="fas fa-bullhorn"></i>
                <div class="marquee-wrapper">
                    <span class="marquee-text" id="notifText">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®...</span>
                </div>
            </div>
            <button class="notif-close" onclick="document.getElementById('notificationBar').style.display='none'">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <header class="chatbot-header">
            <div class="header-content">
                <img src="cicc.png" class="logo" alt="Logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4712/4712035.png'">
                <div class="title-group">
                    <h3>CICC Chatbot</h3>
                    <p>‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‚Ä¢ AI Model CICC</p>
                </div>
            </div>
            <a href="admin.html" class="admin-link"><i class="fas fa-cog"></i></a>
        </header>

        <div class="chat-area" id="chatArea">
            <div class="message-group bot">
                <div class="avatar"><img src="cicc.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4712/4712035.png'"></div>
                <div class="message bot-message">
                    <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ CICC Chatbot<br>‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üëá</p>
                </div>
            </div>
        </div>

        <div class="chat-input-area">
            <div class="quick-menu-bar" id="quickMenuBar">Loading...</div>
            <div class="chat-input-wrapper">
                <textarea id="userInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." rows="1"></textarea>
                <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
            <p class="disclaimer">‚ö† AI ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBs-1OF_k_iUsydZF5DjLFRnv0fcTAJxiE",
      authDomain: "cicc-91f0b.firebaseapp.com",
      databaseURL: "https://cicc-91f0b-default-rtdb.firebaseio.com",
      projectId: "cicc-91f0b",
      storageBucket: "cicc-91f0b.firebasestorage.app",
      messagingSenderId: "596317132498",
      appId: "1:596317132498:web:e5c4bc56a55d26940e7f0b",
      measurementId: "G-GK5FB9CCRF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let botData = [];

    document.addEventListener('DOMContentLoaded', () => {
        startApp();
        setupUI();
        setupScroll();
    });

    function startApp() {
        onValue(ref(db, 'cicc_bot_data'), (snapshot) => {
            botData = snapshot.val() || [];
        });

        onValue(ref(db, 'cicc_quick_btns'), (snapshot) => {
            const btns = snapshot.val() || [];
            renderQuickButtons(btns);
        });

        onValue(ref(db, 'cicc_notification'), (snapshot) => {
            const notif = snapshot.val() || {active: false};
            const bar = document.getElementById('notificationBar');
            if(notif.active && notif.message) {
                document.getElementById('notifText').textContent = notif.message;
                bar.style.display = 'flex';
            } else {
                bar.style.display = 'none';
            }
        });

        push(ref(db, 'cicc_visit_logs'), new Date().toISOString());
    }

    function renderQuickButtons(buttons) {
        const bar = document.getElementById('quickMenuBar');
        bar.innerHTML = '';
        if(buttons.length === 0) { bar.innerHTML = '<span style="font-size:0.8rem; color:#999; padding:5px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏±‡∏î</span>'; return; }
        
        buttons.forEach(btn => {
            const b = document.createElement('button');
            b.className = 'quick-btn';
            b.onclick = () => processUserMessage(btn.message);
            b.innerHTML = `<i class="${btn.icon}"></i> ${btn.label}`;
            bar.appendChild(b);
        });
    }

    // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå (Mouse Wheel) ---
    function setupScroll() {
        const slider = document.getElementById('quickMenuBar');
        slider.addEventListener('wheel', (evt) => {
            evt.preventDefault();
            slider.scrollLeft += evt.deltaY; // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ ‡πÅ‡∏ó‡∏ô ‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á
        });
    }

    window.processUserMessage = function(text) {
        if(!text) return;
        appendMessage('user', text);
        
        setTimeout(() => {
            const reply = getBotResponse(text);
            appendMessage('bot', reply);
        }, 600);
    }

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô) ---
    function getBotResponse(text) {
        text = text.toLowerCase().trim();
        for (let item of botData) {
            if (item.keywords && Array.isArray(item.keywords)) {
                for (let k of item.keywords) {
                    // ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏°‡∏≤ "‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏ú‡∏™‡∏°‡∏≠‡∏¢‡∏π‡πà" ‡∏Å‡πá‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡πÄ‡∏•‡∏¢
                    if (text.includes(k.toLowerCase().trim())) return item.response;
                }
            }
        }
        return "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö";
    }

    function appendMessage(sender, text) {
        const chatArea = document.getElementById('chatArea');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message-group ${sender}`;
        
        let avatarHTML = sender === 'user' 
            ? '<div class="avatar">üë§</div>' 
            : '<div class="avatar"><img src="cicc.png" onerror="this.src=\'https://cdn-icons-png.flaticon.com/512/4712/4712035.png\'"></div>';

        let ttsBtn = '';
        if (sender === 'bot') {
            let plainText = text.replace(/<[^>]*>/g, ' '); 
            ttsBtn = `<button class="tts-btn" onclick="playVoice('${plainText.replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i> ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>`;
        }

        msgDiv.innerHTML = `
            ${avatarHTML}
            <div class="message ${sender}-message">
                ${text}
                ${ttsBtn}
            </div>
        `;
        chatArea.appendChild(msgDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function setupUI() {
        const input = document.getElementById('userInput');
        const btn = document.getElementById('sendBtn');
        
        const send = () => {
            const txt = input.value.trim();
            if(txt) { input.value=''; input.style.height='auto'; processUserMessage(txt); }
        };

        btn.onclick = send;
        input.onkeydown = (e) => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); send(); }};
        input.oninput = function() { this.style.height='auto'; this.style.height=this.scrollHeight+'px'; };
    }

    window.playVoice = function(text) {
        if('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'th-TH';
            window.speechSynthesis.speak(u);
        } else { alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î"); }
    }
</script>
</body>
</html>
