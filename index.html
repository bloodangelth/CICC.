<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CICC Chatbot</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="chatbot-container">
        <div id="notificationBar" class="notification-bar">
            <div class="notif-content">
                <i class="fas fa-bullhorn"></i>
                <div class="marquee-wrapper"><span class="marquee-text" id="notifText"></span></div>
            </div>
            <button class="notif-close" onclick="closeNotification()"><i class="fas fa-times"></i></button>
        </div>

        <header class="chatbot-header">
            <div class="header-content">
                <img src="cicc.png" class="logo" alt="CICC Logo">
                <div class="title-group"><h3>CICC Chatbot</h3><p>‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‚Ä¢ AI Model CICC</p></div>
            </div>
            <a href="admin.html" class="admin-link"><i class="fas fa-cog"></i></a>
        </header>

        <div class="chat-area" id="chatArea">
            <div class="message-group bot">
                <div class="avatar"><img src="cicc.png" alt="Bot"></div>
                <div class="message bot-message">
                    <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ CICC Chatbot ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡∏ö</p>
                    <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üëá</p>
                    <button class="tts-btn" onclick="speakThai('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ CICC Chatbot ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡∏ö')"><i class="fas fa-volume-up"></i> ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
                </div>
            </div>
        </div>

        <div class="chat-input-area">
            <div class="quick-menu-bar" id="quickMenuBar"></div>
            <div class="chat-input-wrapper">
                <textarea id="userInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." rows="1"></textarea>
                <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
            <p class="disclaimer">‚ö† ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- ‡∏£‡∏´‡∏±‡∏™ Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
        const firebaseConfig = {
            apiKey: "AIzaSyBs-1OF_k_iUsydZF5DjLFRnv0fcTAJxiE",
            authDomain: "cicc-91f0b.firebaseapp.com",
            databaseURL: "https://cicc-91f0b-default-rtdb.firebaseio.com",
            projectId: "cicc-91f0b",
            storageBucket: "cicc-91f0b.firebasestorage.app",
            messagingSenderId: "596317132498",
            appId: "1:596317132498:web:e5c4bc56a55d26940e7f0b",
            measurementId: "G-GK5FB9CCRF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.botData = [];
        let voices = [];

        // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        onValue(ref(db, 'cicc_bot_data'), (snapshot) => {
            window.botData = snapshot.val() || [{ keywords: ["‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ"], response: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö" }];
        });

        onValue(ref(db, 'cicc_notification'), (snapshot) => {
            const notif = snapshot.val();
            const bar = document.getElementById('notificationBar');
            if (notif && notif.active && notif.message) {
                document.getElementById('notifText').textContent = notif.message;
                bar.style.display = 'flex';
            } else { bar.style.display = 'none'; }
        });

        onValue(ref(db, 'cicc_quick_btns'), (snapshot) => {
            const btns = snapshot.val();
            const bar = document.getElementById('quickMenuBar');
            bar.innerHTML = '';
            if (btns) {
                btns.forEach(btn => {
                    const button = document.createElement('button');
                    button.className = 'quick-btn';
                    button.onclick = () => window.sendQuickMessage(btn.message);
                    button.innerHTML = `<i class="${btn.icon}"></i> ${btn.label}`;
                    bar.appendChild(button);
                });
            }
        });

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
        const today = new Date().toISOString().split('T')[0];
        const visitedKey = 'cicc_visited_' + today;
        if (!localStorage.getItem(visitedKey)) {
            push(ref(db, 'cicc_visit_logs'), new Date().toISOString());
            localStorage.setItem(visitedKey, 'true'); 
        }

        // --- Logic Chatbot ---
        const chatArea = document.getElementById('chatArea');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PC)
        const qBar = document.getElementById('quickMenuBar');
        qBar.addEventListener('wheel', (evt) => {
            evt.preventDefault();
            qBar.scrollLeft += evt.deltaY; // ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô
        });

        window.sendQuickMessage = (text) => { processUserMessage(text); };
        window.closeNotification = () => { document.getElementById('notificationBar').style.display = 'none'; }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á Native ---
        window.speakThai = (text) => {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'th-TH';
            let thaiVoice = voices.find(v => v.lang === 'th-TH' || v.name.includes('Thai'));
            if(thaiVoice) utterance.voice = thaiVoice;
            window.speechSynthesis.speak(utterance);
        };

        function loadVoices() { voices = window.speechSynthesis.getVoices(); }
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();
        }

        function appendMessage(sender, text) {
            const div = document.createElement('div');
            div.className = `message-group ${sender}`;
            let html = `
                <div class="avatar">${sender === 'user' ? '<span class="avatar-icon">üë§</span>' : '<img src="cicc.png">'}</div>
                <div class="message ${sender}-message">${text}`; 
            
            if(sender === 'bot') {
                let plainText = text.replace(/<[^>]*>/g, ' '); 
                const safeText = plainText.replace(/'/g, "\\'"); 
                html += `<button class="tts-btn" onclick="speakThai('${safeText}')"><i class="fas fa-volume-up"></i> ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>`;
            }
            html += `</div>`;
            div.innerHTML = html;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // --- ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô) ---
        function getBotResponse(text) {
            const msg = text.toLowerCase().trim();
            for (let item of window.botData) {
                if(!item.keywords) continue;
                for (let kw of item.keywords) {
                    // ‡πÉ‡∏ä‡πâ includes() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏ß‡πà‡∏≤ "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå" ‡∏°‡∏µ "‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î" ‡∏ú‡∏™‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°
                    if (msg.includes(kw.toLowerCase().trim())) {
                        return item.response;
                    }
                }
            }
            return "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏±‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö";
        }

        function processUserMessage(text) {
            if(!text) return;
            appendMessage('user', text);
            setTimeout(() => { appendMessage('bot', getBotResponse(text)); }, 500);
        }

        sendBtn.addEventListener('click', () => {
            const text = userInput.value.trim();
            if(text) { userInput.value = ''; userInput.style.height = 'auto'; processUserMessage(text); }
        });

        userInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendBtn.click(); }
        });
        
        userInput.addEventListener('input', function() {
            this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px';
        });
    </script>
</body>
</html>
