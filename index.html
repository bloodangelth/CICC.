<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CICC Chatbot</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <div class="chatbot-container">
        
        <div id="notificationBar" class="notification-bar">
            <div class="notif-content">
                <i class="fas fa-bullhorn"></i>
                <div class="marquee-wrapper">
                    <span class="marquee-text" id="notifText">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®: ...</span>
                </div>
            </div>
            <button class="notif-close" onclick="closeNotification()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <header class="chatbot-header">
            <div class="header-content">
                <img src="cicc.png" class="logo" alt="CICC Logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4712/4712035.png'">
                <div class="title-group">
                    <h3>CICC Chatbot</h3>
                    <p>‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‚Ä¢ AI Model CICC</p>
                </div>
            </div>
            <a href="admin.html" class="admin-link" title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö">
                <i class="fas fa-cog"></i>
            </a>
        </header>

        <div class="chat-area" id="chatArea">
            <div class="message-group bot">
                <div class="avatar">
                    <img src="cicc.png" alt="Bot" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4712/4712035.png'">
                </div>
                <div class="message bot-message">
                    <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ CICC Chatbot ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡∏ö</p>
                    <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üëá</p>
                    
                    <button class="tts-btn" onclick="playFinalVoice('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ CICC Chatbot ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö')">
                        <i class="fas fa-volume-up"></i> ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                    </button>
                </div>
            </div>
        </div>

        <div class="chat-input-area">
            <div class="quick-menu-bar" id="quickMenuBar"></div>

            <div class="chat-input-wrapper">
                <textarea id="userInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." rows="1"></textarea>
                <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
            <p class="disclaimer">‚ö† ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</p>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase (‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Admin) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBs-1OF_k_iUsydZF5DjLFRnv0fcTAJxiE",
      authDomain: "cicc-91f0b.firebaseapp.com",
      databaseURL: "https://cicc-91f0b-default-rtdb.firebaseio.com",
      projectId: "cicc-91f0b",
      storageBucket: "cicc-91f0b.firebasestorage.app",
      messagingSenderId: "596317132498",
      appId: "1:596317132498:web:e5c4bc56a55d26940e7f0b",
      measurementId: "G-GK5FB9CCRF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≠‡∏ó
    let botData = [];
    let currentAudio = null;

    // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Realtime ‡∏à‡∏≤‡∏Å Firebase ---
    function startApp() {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (Bot Data)
        onValue(ref(db, 'cicc_bot_data'), (snapshot) => {
            botData = snapshot.val() || [];
            console.log("Updated Bot Data:", botData);
        });

        // ‡∏î‡∏∂‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏±‡∏î (Quick Buttons)
        onValue(ref(db, 'cicc_quick_btns'), (snapshot) => {
            const btns = snapshot.val() || [];
            renderQuickButtons(btns);
        });

        // ‡∏î‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Notification)
        onValue(ref(db, 'cicc_notification'), (snapshot) => {
            const notif = snapshot.val() || {active: false, message: ""};
            updateNotification(notif);
        });

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏° (‡∏™‡πà‡∏á‡πÑ‡∏õ Firebase ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Admin ‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏£‡∏≤‡∏ü)
        push(ref(db, 'cicc_visit_logs'), new Date().toISOString());
    }

    // --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Render ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
    function renderQuickButtons(buttons) {
        const bar = document.getElementById('quickMenuBar');
        bar.innerHTML = '';
        buttons.forEach(btn => {
            const button = document.createElement('button');
            button.className = 'quick-btn';
            // ‡πÉ‡∏ä‡πâ window.processUserMessage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            button.onclick = () => window.processUserMessage(btn.message);
            button.innerHTML = `<i class="${btn.icon}"></i> ${btn.label}`;
            bar.appendChild(button);
        });
    }

    function updateNotification(notifData) {
        const bar = document.getElementById('notificationBar');
        const text = document.getElementById('notifText');
        if (notifData.active && notifData.message) {
            text.textContent = notifData.message;
            bar.style.display = 'flex';
        } else {
            bar.style.display = 'none';
        }
    }

    // --- 4. Logic ‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó ---
    window.processUserMessage = function(text) {
        if (!text) return;
        appendMessage("user", text);
        
        // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå...
        setTimeout(() => {
            const response = getBotResponse(text);
            appendMessage("bot", response);
        }, 600);
    }

    function getBotResponse(text) {
        const msg = text.toLowerCase().trim();
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å botData ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Firebase
        for (let item of botData) {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ keywords ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏Å‡∏±‡∏ô error)
            if(item.keywords && Array.isArray(item.keywords)){
                for (let keyword of item.keywords) {
                    if (msg.includes(keyword.toLowerCase())) return item.response;
                }
            }
        }
        return "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ \n‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏î‡∏π‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö";
    }

    function appendMessage(sender, text) {
        const chatArea = document.getElementById('chatArea');
        const messageGroup = document.createElement('div');
        messageGroup.classList.add('message-group', sender);

        const avatarDiv = document.createElement('div');
        avatarDiv.classList.add('avatar');
        
        // ‡∏£‡∏π‡∏õ Avatar
        if (sender === 'user') {
            avatarDiv.innerHTML = '<span class="avatar-icon">üë§</span>';
        } else {
            const img = document.createElement('img');
            img.src = 'cicc.png';
            img.onerror = function() { this.src='https://cdn-icons-png.flaticon.com/512/4712/4712035.png'; }; // ‡∏£‡∏π‡∏õ‡∏™‡∏≥‡∏£‡∏≠‡∏á
            avatarDiv.appendChild(img);
        }

        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', `${sender}-message`);
        messageDiv.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`;

        if (sender === 'bot') {
            const ttsButton = document.createElement('button');
            ttsButton.className = 'tts-btn';
            ttsButton.innerHTML = '<i class="fas fa-volume-up"></i> ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
            ttsButton.onclick = function() { window.playFinalVoice(text); };
            messageDiv.appendChild(ttsButton);
        }

        messageGroup.appendChild(avatarDiv);
        messageGroup.appendChild(messageDiv);
        chatArea.appendChild(messageGroup);
        chatArea.scrollTop = chatArea.scrollHeight; // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î
    }

    // --- 5. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Input ‡πÅ‡∏•‡∏∞ Event ---
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;
        userInput.value = "";
        userInput.style.height = "auto"; // Reset height
        window.processUserMessage(text);
    }

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { 
            e.preventDefault(); 
            sendMessage(); 
        }
    });
    userInput.addEventListener("input", function() {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
    });

    // --- 6. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á (TTS) ---
    window.playFinalVoice = function(text) {
        if (currentAudio) { currentAudio.pause(); currentAudio = null; }
        if ('speechSynthesis' in window) window.speechSynthesis.cancel();

        let cleanText = text.replace(/<[^>]*>/g, ' ').replace(/&nbsp;/g, ' ').trim();
        if(!cleanText) return;

        // ‡πÉ‡∏ä‡πâ Google Translate TTS API
        const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(cleanText.substring(0,100))}&tl=th&client=tw-ob`;
        currentAudio = new Audio(url);
        currentAudio.play().catch(e => {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á Browser
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'th-TH';
            window.speechSynthesis.speak(utterance);
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Notification
    window.closeNotification = function() {
        document.getElementById('notificationBar').style.display = 'none';
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    document.addEventListener('DOMContentLoaded', startApp);
</script>

</body>
</html>