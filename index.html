<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CICC Chatbot</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div class="chatbot-container">
        <div id="notificationBar" class="notification-bar">
            <div class="notif-content">
                <i class="fas fa-bullhorn"></i>
                <div class="marquee-wrapper">
                    <span class="marquee-text" id="notifText">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®...</span>
                </div>
            </div>
            <button class="notif-close" onclick="document.getElementById('notificationBar').style.display='none'">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <header class="chatbot-header">
            <div class="header-content">
                <img src="cicc.png" class="logo" alt="Logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4712/4712035.png'">
                <div class="title-group">
                    <h3>CICC Chatbot</h3>
                    <p>‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‚Ä¢ AI Model CICC</p>
                </div>
            </div>
            <a href="admin.html" class="admin-link"><i class="fas fa-cog"></i></a>
        </header>

        <div class="chat-area" id="chatArea">
            <div class="message-group bot">
                <div class="avatar"><img src="cicc.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4712/4712035.png'"></div>
                <div class="message bot-message">
                    <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ CICC Chatbot<br>‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üëá</p>
                </div>
            </div>
        </div>

        <div class="chat-input-area">
            <div class="quick-menu-bar" id="quickMenuBar">Loading...</div>
            <div class="chat-input-wrapper">
                <textarea id="userInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." rows="1"></textarea>
                <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
            <p class="disclaimer">‚ö† AI ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBs-1OF_k_iUsydZF5DjLFRnv0fcTAJxiE",
      authDomain: "cicc-91f0b.firebaseapp.com",
      databaseURL: "https://cicc-91f0b-default-rtdb.firebaseio.com",
      projectId: "cicc-91f0b",
      storageBucket: "cicc-91f0b.firebasestorage.app",
      messagingSenderId: "596317132498",
      appId: "1:596317132498:web:e5c4bc56a55d26940e7f0b",
      measurementId: "G-GK5FB9CCRF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let botData = [];

    document.addEventListener('DOMContentLoaded', () => {
        startApp();
        setupUI();
        setupScroll();
    });

    function startApp() {
        onValue(ref(db, 'cicc_bot_data'), (snapshot) => {
            botData = snapshot.val() || [];
        });

        onValue(ref(db, 'cicc_quick_btns'), (snapshot) => {
            const btns = snapshot.val() || [];
            renderQuickButtons(btns);
        });

        onValue(ref(db, 'cicc_notification'), (snapshot) => {
            const notif = snapshot.val() || {active: false};
            const bar = document.getElementById('notificationBar');
            if(notif.active && notif.message) {
                document.getElementById('notifText').textContent = notif.message;
                bar.style.display = 'flex';
            } else {
                bar.style.display = 'none';
            }
        });

        push(ref(db, 'cicc_visit_logs'), new Date().toISOString());
    }

    function renderQuickButtons(buttons) {
        const bar = document.getElementById('quickMenuBar');
        bar.innerHTML = '';
        if(buttons.length === 0) { bar.innerHTML = '<span style="font-size:0.8rem; color:#999; padding:5px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏±‡∏î</span>'; return; }
        
        buttons.forEach(btn => {
            const b = document.createElement('button');
            b.className = 'quick-btn';
            b.onclick = () => processUserMessage(btn.message);
            b.innerHTML = `<i class="${btn.icon}"></i> ${btn.label}`;
            bar.appendChild(b);
        });
    }

    function setupScroll() {
        const slider = document.getElementById('quickMenuBar');
        slider.addEventListener('wheel', (evt) => {
            evt.preventDefault();
            slider.scrollLeft += evt.deltaY;
        });
    }

    window.processUserMessage = function(text) {
        if(!text) return;
        appendMessage('user', text);
        
        setTimeout(() => {
            const reply = getBotResponse(text);
            appendMessage('bot', reply);
        }, 600);
    }

    function getBotResponse(text) {
        const msgClean = text.toLowerCase().replace(/\s+/g, ''); 
        
        let bestMatchResponse = null;
        let highestScore = 0;
        let bestRatio = 0;

        function getLCS(s1, s2) {
            let maxLen = 0;
            let dp = Array(s1.length + 1).fill(0).map(() => Array(s2.length + 1).fill(0));
            for (let i = 1; i <= s1.length; i++) {
                for (let j = 1; j <= s2.length; j++) {
                    if (s1[i - 1] === s2[j - 1]) {
                        dp[i][j] = dp[i - 1][j - 1] + 1;
                        if (dp[i][j] > maxLen) maxLen = dp[i][j];
                    }
                }
            }
            return maxLen;
        }

        for (let item of botData) {
            if (item.keywords && Array.isArray(item.keywords)) {
                for (let k of item.keywords) {
                    const kwClean = k.toLowerCase().replace(/\s+/g, '');
                    if (kwClean.length < 2) continue;

                    let matchLength = getLCS(msgClean, kwClean);
                    let minRequired = Math.min(4, Math.ceil(kwClean.length * 0.6));
                    
                    if (matchLength >= minRequired) {
                        let ratio = matchLength / kwClean.length;
                        if (matchLength > highestScore || (matchLength === highestScore && ratio > bestRatio)) {
                            highestScore = matchLength;
                            bestRatio = ratio;
                            bestMatchResponse = item.response;
                        }
                    }
                }
            }
        }

        if (bestMatchResponse) return bestMatchResponse;
        return "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏±‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö";
    }

    function appendMessage(sender, text) {
        const chatArea = document.getElementById('chatArea');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message-group ${sender}`;
        
        let avatarHTML = sender === 'user' 
            ? '<div class="avatar">üë§</div>' 
            : '<div class="avatar"><img src="cicc.png" onerror="this.src=\'https://cdn-icons-png.flaticon.com/512/4712/4712035.png\'"></div>';

        let ttsBtns = '';
        if (sender === 'bot') {
            // ‡∏Ñ‡∏•‡∏µ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏û‡∏±‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô playVoice
            let plainText = text.replace(/<[^>]*>/g, ' ') // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏ó‡πá‡∏Å HTML ‡∏≠‡∏≠‡∏Å
                                .replace(/'/g, "\\'")     // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ single quote
                                .replace(/"/g, "&quot;")  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ double quote
                                .replace(/\n/g, ' ');     // ‡πÄ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏≠‡∏Å
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏µ‡πÅ‡∏î‡∏á
            ttsBtns = `
                <div style="margin-top: 10px; display: flex; gap: 5px;">
                    <button class="tts-btn" onclick="playVoice('${plainText}')"><i class="fas fa-volume-up"></i> ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
                    <button class="tts-btn" onclick="stopVoice()" style="background: #ff4d4d; color: white;"><i class="fas fa-stop"></i> ‡∏´‡∏¢‡∏∏‡∏î</button>
                </div>
            `;
        }

        msgDiv.innerHTML = `
            ${avatarHTML}
            <div class="message ${sender}-message">
                ${text}
                ${ttsBtns}
            </div>
        `;
        chatArea.appendChild(msgDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function setupUI() {
        const input = document.getElementById('userInput');
        const btn = document.getElementById('sendBtn');
        
        const send = () => {
            const txt = input.value.trim();
            if(txt) { input.value=''; input.style.height='auto'; processUserMessage(txt); }
        };

        btn.onclick = send;
        input.onkeydown = (e) => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); send(); }};
        input.oninput = function() { this.style.height='auto'; this.style.height=this.scrollHeight+'px'; };
    }

    // --- ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡∏Ñ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏´‡∏≤‡∏¢ + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏¢‡∏∏‡∏î) ---
    window.currentUtterance = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á (Garbage Collection)

    window.playVoice = function(text) {
        if('speechSynthesis' in window) {
            window.speechSynthesis.cancel(); // ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
            
            // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡∏Ñ‡∏Å‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î
            setTimeout(() => {
                window.currentUtterance = new SpeechSynthesisUtterance(text);
                window.currentUtterance.lang = 'th-TH';
                window.speechSynthesis.speak(window.currentUtterance);
            }, 50);
        } else { 
            alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡∏Ñ‡∏£‡∏±‡∏ö"); 
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    window.stopVoice = function() {
        if('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
        }
    }
</script>
</body>
</html>
